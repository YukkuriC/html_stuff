<html>

<head>
    <meta charset="utf-8">
    <title>San Check曲线</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.0.0-beta3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.1.0/echarts.min.js"></script>
    <script>
        var CACHE = {}
        function CalcTimes(san, dsuccess, dfail) {
            if (san < 1) return 0
            // cached
            var key = `${san},${dsuccess},${dfail}`
            if (!(key in CACHE)) {
                // success
                var esuccess = 0
                for (var i = 1; i <= dsuccess; i++)
                    esuccess += CalcTimes(san - i, dsuccess, dfail)
                esuccess /= dsuccess
                // fail
                var efail = 0
                for (var i = 1; i <= dfail; i++)
                    efail += CalcTimes(san - i, dsuccess, dfail)
                efail /= dfail
                // total
                var res = 100
                res += san * esuccess
                res += (100 - san) * efail
                CACHE[key] = res / 100
            }
            return CACHE[key]
        }
        function CalcMeanDmg(san, dsuccess, dfail) {
            var res = san * (1 + dsuccess)
            res += (100 - san) * (1 + dfail)
            return res / 200
        }
    </script>
    <style>
        button.active {
            background-color: yellow !important;
        }

        h4 {
            text-align: center;
        }
    </style>
</head>

<body onload='UpdateVisuals()'>
    <div class='container'>
        <br>
        <h4>关于多少次SC能把人抬走这件事</h4>
        <div class='row'>
            <div class='col-sm-6'>
                <div>成功骰数</div>
                <div id='btn-success'></div>
            </div>
            <div class='col-sm-6'>
                <div>失败骰数</div>
                <div id='btn-fail'></div>
            </div>
        </div>
        <div id='main'></div>
    </div>
    <script>
        BUTTONS = []
        DSUCCESS = 10
        DFAIL = 100

        // 按钮
        DICES = [1, 3, 6, 10, 100, 114, 514]
        for (var type of ['success', 'fail'])
            for (var size of DICES)
                GenButton(type, size)

        // eCharts
        var chartDom = document.getElementById('main');
        Object.assign(chartDom.style, {
            width: `${chartDom.offsetWidth}px`,
            height: `${window.innerHeight - chartDom.offsetTop}px`,
        })
        var myChart = echarts.init(chartDom);
        var options = option = {
            title: { text: '' },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    label: {
                        formatter: params => `San值: ${params.value}`,
                    }
                },
            },
            xAxis: {
                data: [],
            },
            yAxis: [
                {
                    axisLine: {
                        onZero: false,
                        lineStyle: { color: '#c2c' }
                    },
                    min: v => 1,
                },
                {
                    axisLine: {
                        onZero: false,
                        lineStyle: { color: '#c92' }
                    },
                }
            ],
            series: [{
                name: '所需平均次数',
                data: [],
                type: 'line',
                color: '#c2f',
                emphasis: { focus: 'series' },
            },
            {
                name: '单次平均伤害',
                data: [],
                type: 'line',
                color: '#fa2',
                yAxisIndex: 1,
                emphasis: { focus: 'series' },
            }]
        };
        for (var i = 100; i >= 1; i--)
            options.xAxis.data.push(i)

        function GenButton(type, size) {
            var btn = document.createElement('button')
            btn.className = 'btn btn-info btn-sm'
            btn.innerText = (size == 1) ? '1' : `1D${size}`
            btn.target = 'D' + type.toUpperCase()
            btn.size = size
            btn.addEventListener('click', () => {
                window[btn.target] = size
                UpdateVisuals()
            })
            BUTTONS.push(btn)
            document.getElementById('btn-' + type).appendChild(btn)
        }

        function UpdateVisuals() {
            // 按钮高亮
            BUTTONS.forEach(btn => {
                btn.classList.remove('active')
                if (window[btn.target] == btn.size) btn.classList.add('active')
            })
            options.title.text = `San Check 1D${DSUCCESS}/1D${DFAIL}`

            // 计算san
            options.series.forEach(s => s.data = [])
            for (var i = 100; i >= 1; i--) {
                options.series[0].data.push(CalcTimes(i, DSUCCESS, DFAIL))
                options.series[1].data.push(CalcMeanDmg(i, DSUCCESS, DFAIL))
            }

            // 更新eCharts
            myChart.setOption(option)
        }
    </script>
</body>

</html>